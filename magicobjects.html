<!DOCTYPE html><html><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type" /><meta content="width=device-width, initial-scale=1" name="viewport" /><!--replace-start-0--><!--replace-start-5--><!--replace-start-8--><title>Magic Python Objects - Noah&#39;s Knowledge Graph</title><!--replace-end-8--><!--replace-end-5--><!--replace-end-0--><link href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css" rel="stylesheet" /><link href="https://fonts.googleapis.com/css?family=Merriweather|Libre+Franklin|Roboto+Mono&amp;display=swap" rel="stylesheet" /><!--replace-start-1--><!--replace-start-4--><!--replace-start-7--><link href="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" rel="icon" /><meta content="Noah Pederson" name="author" /><meta content="" name="description" /><link href="https://packetlost.dev/magicobjects.html" rel="canonical" /><meta content="Magic Python Objects" property="og:title" /><meta content="Noah&#39;s Knowledge Graph" property="og:site_name" /><meta content="article" property="og:type" /><meta content="https://images.unsplash.com/photo-1551269901-5c5e14c25df7?ixlib=rb-1.2.1&amp;q=85&amp;fm=jpg&amp;crop=entropy&amp;cs=srgb&amp;ixid=eyJhcHBfaWQiOjYzOTIxfQ&amp;w=3600" property="og:image" /><script type="application/ld+json">[{"@context":"https://schema.org","itemListElement":[{"name":"Python Libraries","item":"https://packetlost.dev/5be67531.html","@type":"ListItem","position":1}],"@type":"BreadcrumbList"},{"@context":"https://schema.org","itemListElement":[{"name":"Blogposts","item":"https://packetlost.dev/blogposts.html","@type":"ListItem","position":1}],"@type":"BreadcrumbList"}]</script><style type="text/css">body{background-color:#eeeeee !important;font-family:"Libre Franklin", serif !important}body .ui.container{font-family:"Libre Franklin", serif !important}body h1, h2, h3, h4, h5, h6, .ui.header, .headerFont{font-family:"Merriweather", sans-serif !important}body code, pre, tt, .monoFont{font-family:"Roboto Mono","SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace !important}body div.z-index p.info{color:#808080}body div.z-index ul{list-style-type:square;padding-left:1.5em}body div.z-index .uplinks{margin-left:0.29999em}body .zettel-content h1#title-h1{background-color:rgba(100,53,201,0.1)}body nav.bottomPane{background-color:rgba(100,53,201,2.0e-2)}body div#footnotes{border-top-color:#6435c9}body p{line-height:150%}body img{max-width:100%}body .deemphasized{font-size:0.94999em}body .deemphasized:hover{opacity:1}body .deemphasized:not(:hover){opacity:0.69999}body .deemphasized:not(:hover) a{color:#808080 !important}body div.container.universe{padding-top:1em}body div.zettel-view ul{padding-left:1.5em;list-style-type:square}body div.zettel-view .pandoc .highlight{background-color:#ffff00}body div.zettel-view .pandoc .ui.disabled.fitted.checkbox{margin-right:0.29999em;vertical-align:middle}body div.zettel-view .zettel-content .metadata{margin-top:1em}body div.zettel-view .zettel-content .metadata div.date{text-align:center;color:#808080}body div.zettel-view .zettel-content h1{padding-top:0.2em;padding-bottom:0.2em;text-align:center}body div.zettel-view .zettel-content h2{border-bottom:solid 1px #4682b4;margin-bottom:0.5em}body div.zettel-view .zettel-content h3{margin:0px 0px 0.4em 0px}body div.zettel-view .zettel-content h4{opacity:0.8}body div.zettel-view .zettel-content div#footnotes{margin-top:4em;border-top-style:groove;border-top-width:2px;font-size:0.9em}body div.zettel-view .zettel-content div#footnotes ol > li > p:only-of-type{display:inline;margin-right:0.5em}body div.zettel-view .zettel-content aside.footnote-inline{width:30%;padding-left:15px;margin-left:15px;float:right;background-color:#d3d3d3}body div.zettel-view .zettel-content .overflows{overflow:auto}body div.zettel-view .zettel-content code{margin:auto auto auto auto;font-size:100%}body div.zettel-view .zettel-content p code, li code, ol code{padding:0.2em 0.2em 0.2em 0.2em;background-color:#f5f2f0}body div.zettel-view .zettel-content pre{overflow:auto}body div.zettel-view .zettel-content dl dt{font-weight:bold}body div.zettel-view .zettel-content blockquote{background-color:#f9f9f9;border-left:solid 10px #cccccc;margin:1.5em 0px 1.5em 0px;padding:0.5em 10px 0.5em 10px}body div.zettel-view .zettel-content.raw{background-color:#dddddd}body .ui.label.zettel-tag{color:#000000}body .ui.label.zettel-tag a{color:#000000}body nav.bottomPane ul.backlinks > li{padding-bottom:0.4em;list-style-type:disc}body nav.bottomPane ul.context-list > li{list-style-type:lower-roman}body .footer-version img{-webkit-filter:grayscale(100%);-moz-filter:grayscale(100%);-ms-filter:grayscale(100%);-o-filter:grayscale(100%);filter:grayscale(100%)}body .footer-version img:hover{-webkit-filter:grayscale(0%);-moz-filter:grayscale(0%);-ms-filter:grayscale(0%);-o-filter:grayscale(0%);filter:grayscale(0%)}body .footer-version, .footer-version a, .footer-version a:visited{color:#808080}body .footer-version a{font-weight:bold}body .footer-version{margin-top:1em !important;font-size:0.69999em}@media only screen and (max-width: 768px){body div#zettel-container{margin-left:0.4em !important;margin-right:0.4em !important}}body span.zettel-link-container span.zettel-link a{color:#6435c9;font-weight:bold;text-decoration:none}body span.zettel-link-container span.zettel-link a:hover{background-color:rgba(100,53,201,0.1)}body span.zettel-link-container span.extra{color:auto}body span.zettel-link-container.errors{border:solid 1px #ff0000}body span.zettel-link-container.errors span.zettel-link a:hover{text-decoration:none !important;cursor:not-allowed}body [data-tooltip]:after{font-size:0.69999em}body div.tag-tree div.node{font-weight:bold}body div.tag-tree div.node a.inactive{color:#555555}body .tree.flipped{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}body .tree{overflow:auto}body .tree ul.root{padding-top:0px;margin-top:0px}body .tree ul{position:relative;padding:1em 0px 0px 0px;white-space:nowrap;margin:0px auto 0px auto;text-align:center}body .tree ul::after{content:"";display:table;clear:both}body .tree ul:last-child{padding-bottom:0.1em}body .tree li{display:inline-block;vertical-align:top;text-align:center;list-style-type:none;position:relative;padding:1em 0.5em 0em 0.5em}body .tree li::before{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{right:auto;left:50%;border-left:solid 2px #cccccc}body .tree li:only-child{padding-top:0em}body .tree li:only-child::after{display:none}body .tree li:only-child::before{display:none}body .tree li:first-child::before{border-style:none;border-width:0px}body .tree li:first-child::after{border-radius:5px 0px 0px 0px}body .tree li:last-child::after{border-style:none;border-width:0px}body .tree li:last-child::before{border-right:solid 2px #cccccc;border-radius:0px 5px 0px 0px}body .tree ul ul::before{content:"";position:absolute;top:0px;left:50%;border-left:solid 2px #cccccc;width:0px;height:1.19999em}body .tree li div.forest-link{border:solid 2px #cccccc;padding:0.2em 0.29999em 0.2em 0.29999em;text-decoration:none;display:inline-block;border-radius:5px 5px 5px 5px;color:#333333;position:relative;top:2px}body .tree.flipped li div.forest-link{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}</style><script async="" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css" rel="stylesheet" /><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-core.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/plugins/autoloader/prism-autoloader.min.js"></script><!--replace-end-7--><!--replace-end-4--><!--replace-end-1--></head><body><div class="ui fluid container universe"><!--replace-start-2--><!--replace-start-3--><!--replace-start-6--><nav class="flipped tree deemphasized" id="zettel-uptree" style="transform-origin: 50%"><ul class="root"><li><ul><li><div class="forest-link"><span class="zettel-link-container"><span class="zettel-link" title="2021-03-03T10:05"><a href="blogposts.html">Blogposts</a></span></span></div></li><li><div class="forest-link"><span class="zettel-link-container"><span class="zettel-link" title="2020-12-21T11:13"><a href="5be67531.html">Python Libraries</a></span></span></div></li></ul></li></ul></nav><div class="ui text container" id="zettel-container" style="position: relative"><div class="zettel-view"><article class="ui raised attached segment zettel-content"><div class="pandoc"><h1 id="title-h1">Magic Python Objects</h1><h2 id="defining-and-encoding-strict-types-using-bare">Defining and Encoding Strict Types Using BARE</h2><p><img src="https://images.unsplash.com/photo-1551269901-5c5e14c25df7?ixlib=rb-1.2.1&amp;q=85&amp;fm=jpg&amp;crop=entropy&amp;cs=srgb&amp;ixid=eyJhcHBfaWQiOjYzOTIxfQ&amp;w=3600" /></p><p>Everything in Python is an object, and I mean everything. This includes primitives such as <code>int</code>, <code>float</code>, and <code>str</code> but also includes things you might not expect, such as <code>class</code> and function definitions. It turns out, that Python has a <em>lot</em> of flexibility and… weird things you can do with class fields.</p><!--more-->
<h2 id="descriptors---but-what-do-they-describe">Descriptors - But what do they describe?</h2><p><code>@property</code>, <code>super()</code>, and <code>@staticmethod</code> (and many others) are implemented using an <em>advanced</em> internal protocol called the descriptor protocol. In short, descriptors are objects that define ‘binding’ behavior in the form of overriding <code>__get__()</code>, <code>__set__()</code>, and <code>__delete__()</code>.</p><p>Without going into detail too on how these functions work, at a basic level they’re invoked whenever a property is set (ex. <code>setattr()</code>), read (ex. <code>getattr()</code>), or deleted (ex. <code>del</code> or <code>delattr()</code>). The protocol has some nuances to be aware of, I recommend reading the <a href="https://docs.python.org/3/howto/descriptor.html">Descriptor HowTo Guide</a> for more information.</p><h2 id="thats-cool-but-what-can-i-do-with-them">That’s cool, but what can I do with them?</h2><p>As mentioned, common class definition and interaction utilities are created using the descriptor protocol. One more potential use is validation for values being set to a property. The <code>property.setter</code> decorator provides a method for doing this generically on classes, but what if you want to “statically” define a type for a class member? Well you can do that too! Here’s an example:</p><pre><code class="python language-python">from abc import ABC, abstractmethod
class Field(ABC):

    def __set_name__(self, owner, name):
        # name is the attr name of *this* instance when assigned as a class field on
        # another object
        self.name = name
        # set the value we have wrapped (if any) to name prefixed with an &#39;_&#39; on the owner
        # instance
        setattr(owner, f&quot;_{name}&quot;, self._value)

    def __get__(self, instance, owner=None):
        if instance is None:
            return self
        else:
            return getattr(instance, f&quot;_{self.name}&quot;)

    def __set__(self, instance, value):
        if instance is None:
            raise AttributeError(&quot;Unable to assign value when not attached to object&quot;)
        valid, message = self.validate(value)
        if not valid:
            # defined elsewhere :)
            raise ValidationError(
                f&quot;value is invalid for BARE type {self._type.__class__.__name__}: {message}&quot;
            )
        setattr(instance, f&quot;_{self.name}&quot;, value)

    @abstractmethod
    def validate(self, value) -&gt; typing.Tuple[bool, str]:
        &quot;&quot;&quot;
        Checks whether a give value is valid for the Field&#39;s data type. Returns a tuple of a boolean
        and an optional message for why
        &quot;&quot;&quot;
        return self.__class__._default == None  # This is valid for BareType.Void</code></pre><p>The above code is a snippet taken from my implementation of the <a href="https://baremessages.org/">BARE message encoding protocol</a> for Python: <a href="https://sr.ht/~chiefnoah/pybare/">PyBARE</a>. It provides a declarative method for defining data containers that can easily be serialized and deserialized to byte streams.</p><p>The above defined <code>Field</code> classes primary purpose is to be subclassed with a specific type definition (all of the native BARE types are provided), and declared as class members on either <code>Struct</code> objects or some other data container. A simple declaration using some of the native types look like this:</p><pre><code class="python language-python">class Example(Struct):

    testint = Int()
    teststr = Str()</code></pre><p>In this example, both <code>Int</code> and <code>Str</code> are subclasses of <code>Field</code>. When the above line is <code>import</code>ed or loaded by the interpreter, <code>Int.__set_name__()</code> and <code>Str.__set_name__()</code> are called with the names “testinst” and “teststr” respectively.</p><p>Note: even though <code>Int</code> and <code>Str</code> are instances, they do not currently hold real values. You must create an instance of <code>Example</code> and assign the values for testint and teststr.</p><p>Those names are store as instance attributes so when a value is assigned to them through an instance of <code>Example</code>, the value can be assigned to an internal representation of that value using <code>Field.__set__()</code>. That’s as easy as you would expect:</p><pre><code class="python language-python">ex = Example()
ex.testint = 2
ex.teststr = &quot;Hello world&quot; # call looks like: Field.__set__(self, ex, &quot;Hello world&quot;)
print(ex.teststr) # &quot;Hello world&quot;
print(ex._teststr) # &quot;Hello world&quot;, the actual value is stored as an instance attribute on ex</code></pre><p>The way the values are stored may seem a bit odd, but it’s necessary to prevent multiple instances of <code>Example</code> from sharing values, given that the <code>testint</code> and <code>teststr</code> instances are class fields.</p><p>You may have noticed this peculiar line:</p><pre><code class="python language-python">    def __get__(self, instance, owner=None):
        if instance is None:
            return self</code></pre><p>The <code>__get__()</code> method of <code>Field</code> checks if <code>instance</code> is <code>None</code> and returns itself if it is… huh??</p><p>This may seem unintuitive, but what it does is allows the <code>Field</code> to be accessed as it’s instance (not it’s wrapped value) when accessed as a <em>class attribute</em>. To clarify:</p><pre><code class="python language-python">ex = Example(testint=1, teststr=&quot;hello&quot;)
ex.testint # 1
Example.testint # &lt;bare.Int object at ...&gt;</code></pre><p>This mimics “shadowing” behavior on the instance vs class versions of the attribute and is particularly helpful when serializing because you can simply call <code>self.__class__.testint.pack(self.testint)</code> to pack the value.</p><p>So what’s with that <code>validate</code> method?</p><p>Well, one of the primary goals for PyBARE was to provide validation as early as possible. Most serializers wait until a method is called to serialize a data-structure to validate it. I’m of the opinion that if you’re going through the trouble to explicitly define what is and isn’t a valid value, you should error as soon as possible. Invalid data is always invalid. Yes, this may seem a bit antithetical to Python’s duck-typing system, but when you have sufficiently complex data containers with strict typing requirements (and your physicist coworkers are married to <code>numpy</code>), you do what you can.</p><p>So what happens when you try to do something that doesn’t fit in a data type? A <code>bare.ValidationError</code> is raised!</p><pre><code class="python language-python">ex = Example()
ex.testint = &quot;1&quot; # raises: ValidationError
ex.teststr = 1 # raises: ValidationError</code></pre><p>If you absolutely <em>must</em> set one of these values to something that doesn’t pass validation, you can always directly set the internal values:</p><pre><code class="python language-python">ex._testint = &quot;1&quot; # no validation</code></pre><p>Alternatively, you can define your own <code>Field</code> type and <code>validation</code> method to do your own validation:</p><pre><code class="python language-python">class IntStr(Str):
    def validate(self, value) j-&gt; Tuple[bool, str]:
        if not isinstance(value, (int, str)):
            return False, f&quot;Wrote type: {type(value)} must be &lt;str&gt; or &lt;int&gt;&quot;
        return True, None</code></pre><p>The above code will fail if you try to serialize it, you must also define a <code>_pack</code> method in order to support both <code>str</code> and <code>int</code> types. This is considered an “advanced” usage of the library, I recommend looking at <a href="https://git.sr.ht/~chiefnoah/pybare/tree/master/bare/types.py">types.py</a> for how this is done internally and imitating how it is done there.</p><p>The native BARE types should cover most needs, so you shouldn’t need to define your own validation.</p><p>This is a serialization library… right? Well, yeah… but serialization is actually secondary to being able to concretely define types and structures for a non-self-describing protocol such as BARE.</p><p>PyBARE puts an emphasis on streaming (unlike most Python libraries, as I’ve found). Though it’s optional, you can provide a <code>BytesIO</code> object or similar (such as a file-like object opened in binary/b mode) to a <code>Struct</code>s <code>pack()</code> method, and it will write the bytes directly to that stream like so:</p><pre><code class="python language-python">ex = Example(teststr=&quot;Hello world&quot;, testint=3)
buffer = io.BytesIO()
ex.pack(fp=buffer) # writes output directly to buffer
buffer.seek(0) # reset the buffer so we can read from it
#now unpack
unpacked = ex.unpack(buffer)
unpacked.testint # 3
unpacked.teststr # &quot;Hello world&quot;</code></pre><p>If you don’t want to use streaming, you can omit the <code>fp</code> kwarg for <code>pack</code> and it will directly return the encoded <code>bytes</code>. For <code>unpack</code>, a <code>bytes</code>-like can be passed in and it will behave the same.</p><p>The primary benefit to streaming, aside from potentially better use of memory, is you can repeatedly serialize and deserialize messages on the same stream. This makes it easy to implement simple RPCs over pipes or other sockets or write many messages in an efficient manner.</p><hr /><p>This has only been a surface-level overview of what PyBARE can do. If you’d like to learn more, I encourage you to look at the several examples in <a href="https://git.sr.ht/~chiefnoah/pybare/tree/master/bare/test_encoder.py">tests for the library</a> as well as <a href="https://baremessages.org/">official spec for BARE.</a> Patches and feature requests are welcome!</p><p><a href="https://pypi.org/project/pybare/">PyBARE is available on PyPi.</a></p><p>Thanks for reading! If you have any questions or comments, shoot me an email at <a href="mailto:noah@packetlost.dev"><a href="mailto:noah@packetlost.dev">noah@packetlost.dev</a></a>.</p></div><div class="metadata"><div class="date" title="Zettel date"><time datetime="2020-09-08T12:00">2020-09-08</time></div></div></article><nav class="ui attached segment deemphasized backlinksPane" id="neuron-backlinks-pane"><h3 class="ui header">Backlinks</h3><ul class="backlinks"><li><span class="zettel-link-container cf"><span class="zettel-link" title="2020-10-20T22:35"><a href="dd530aa1.html">Programming Languages</a></span></span><ul class="context-list" style="zoom: 85%;"></ul></li><li><span class="zettel-link-container cf"><span class="zettel-link"><a href=".">Noah’s Knowledgebase</a></span></span><ul class="context-list" style="zoom: 85%;"></ul></li></ul><h3 class="ui header"><span title="Backlinks from folgezettel parents">Uplinks</span></h3><ul class="backlinks"><li><span class="zettel-link-container folge"><span class="zettel-link" title="2021-03-03T10:05"><a href="blogposts.html">Blogposts</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span><ul class="context-list" style="zoom: 85%;"></ul></li><li><span class="zettel-link-container folge"><span class="zettel-link" title="2020-12-21T11:13"><a href="5be67531.html">Python Libraries</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span><ul class="context-list" style="zoom: 85%;"><li class="item"><div class="pandoc"><span class="zettel-link-container folge"><span class="zettel-link" title="2020-09-08T12:00"><a href="magicobjects.html">Magic Python Objects</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span></div></li></ul></li></ul></nav><nav class="ui attached segment deemphasized bottomPane" id="neuron-tags-pane"><div><span class="ui basic label zettel-tag" title="Tag">blog/published</span><span class="ui basic label zettel-tag" title="Tag">software/languages/python</span></div></nav><nav class="ui bottom attached icon compact inverted menu violet" id="neuron-nav-bar"><!--replace-start-9--><a class="item" href="." title="Home"><i class="home icon"></i></a><!--replace-end-9--><a class="item" href="https://github.com/chiefnoah/zettelkasten/edit/master/./magicobjects.md" title="Edit this page"><i class="edit icon"></i></a><a class="right item" href="impulse.html" title="Open Impulse"><i class="wave square icon"></i></a></nav></div></div><!--replace-end-6--><!--replace-end-3--><!--replace-end-2--><div class="ui center aligned container footer-version"><div class="ui tiny image"><a href="https://neuron.zettel.page"><img alt="logo" src="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" title="Generated by Neuron 1.9.27.0" /></a></div></div></div></body></html>